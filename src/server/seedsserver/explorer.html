<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTR Explorer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-deep: #0a0e17;
  --bg-card: #111827;
  --bg-card-hover: #1a2332;
  --border: #1e293b;
  --border-glow: #22d3ee33;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-dim: #64748b;
  --accent-cyan: #22d3ee;
  --accent-blue: #3b82f6;
  --accent-emerald: #10b981;
  --accent-amber: #f59e0b;
  --accent-rose: #f43f5e;
  --accent-violet: #8b5cf6;
  --font-mono: 'JetBrains Mono', monospace;
  --font-sans: 'Noto Sans JP', sans-serif;
}

body {
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-sans);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Noise overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="4" stitchTiles="stitch"/></filter><rect width="200" height="200" filter="url(%23n)" opacity="0.03"/></svg>');
  pointer-events: none;
  z-index: 9999;
}

/* Header */
.header {
  background: linear-gradient(180deg, #0f172a 0%, transparent 100%);
  border-bottom: 1px solid var(--border);
  padding: 1.2rem 2rem;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
}

.header-inner {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.7rem;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 14px;
  color: #000;
}

.logo-text {
  font-family: var(--font-mono);
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: 2px;
}

.logo-sub {
  font-size: 0.7rem;
  color: var(--text-dim);
  font-weight: 300;
  letter-spacing: 1px;
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--accent-emerald);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent-emerald);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--accent-emerald); }
  50% { opacity: 0.5; box-shadow: 0 0 12px var(--accent-emerald); }
}

/* Main layout */
.main {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1.5rem 2rem 4rem;
}

/* Search bar */
.search-bar {
  margin-bottom: 1.5rem;
}

.search-input {
  width: 100%;
  padding: 0.8rem 1.2rem;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg-card);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 0.85rem;
  outline: none;
  transition: border-color 0.2s;
}

.search-input::placeholder { color: var(--text-dim); }
.search-input:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 3px var(--border-glow); }

/* Stats grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.1rem 1.3rem;
  transition: border-color 0.2s;
}

.stat-card:hover { border-color: var(--border-glow); }

.stat-label {
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 0.3rem;
}

.stat-value {
  font-family: var(--font-mono);
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--text-primary);
}

.stat-value .unit {
  font-size: 0.7rem;
  color: var(--text-secondary);
  font-weight: 400;
  margin-left: 0.3rem;
}

.stat-sub {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 0.2rem;
  font-family: var(--font-mono);
}

/* Charts section */
.charts-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.2rem;
}

.chart-title {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 0.8rem;
}

.chart-wrap {
  position: relative;
  height: 200px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0;
}

.tab {
  padding: 0.6rem 1.2rem;
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--text-dim);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  background: none;
  border-top: none;
  border-left: none;
  border-right: none;
  font-family: var(--font-sans);
}

.tab:hover { color: var(--text-secondary); }
.tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }

/* Table */
.table-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
}

thead th {
  padding: 0.7rem 1rem;
  text-align: left;
  font-weight: 500;
  color: var(--text-dim);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border);
  background: #0d1321;
}

tbody tr {
  border-bottom: 1px solid #1a2332;
  transition: background 0.15s;
}

tbody tr:hover { background: var(--bg-card-hover); }
tbody tr:last-child { border-bottom: none; }

td {
  padding: 0.65rem 1rem;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text-secondary);
}

td.height-cell {
  color: var(--accent-cyan);
  font-weight: 500;
}

td.hash-cell {
  color: var(--text-dim);
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

td.miner-cell {
  color: var(--accent-violet);
  max-width: 140px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

td.reward-cell { color: var(--accent-amber); }
td.time-cell { color: var(--text-dim); font-size: 0.72rem; }
td.tx-cell { color: var(--text-secondary); text-align: center; }
td.diff-cell { color: var(--accent-emerald); }

/* Balance result */
.balance-result {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  display: none;
}

.balance-result.show { display: block; }

.balance-addr {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  color: var(--accent-violet);
  word-break: break-all;
  margin-bottom: 0.8rem;
}

.balance-amount {
  font-family: var(--font-mono);
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-amber);
}

.balance-amount .btr { font-size: 0.9rem; color: var(--text-dim); font-weight: 400; }

/* Loading */
.loading {
  text-align: center;
  padding: 2rem;
  color: var(--text-dim);
  font-size: 0.85rem;
}

/* Responsive */
@media (max-width: 900px) {
  .charts-section { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .main { padding: 1rem; }
  .header { padding: 0.8rem 1rem; }
}

@media (max-width: 600px) {
  .stats-grid { grid-template-columns: 1fr; }
  table { font-size: 0.72rem; }
  td, th { padding: 0.5rem 0.6rem; }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">B</div>
      <div>
        <div class="logo-text">BTR EXPLORER</div>
        <div class="logo-sub">Buturi Coin Blockchain</div>
      </div>
    </div>
    <div class="status-badge" id="statusBadge">
      <div class="status-dot"></div>
      <span id="statusText">接続中...</span>
    </div>
  </div>
</header>

<main class="main">
  <!-- Search -->
  <div class="search-bar">
    <input class="search-input" id="searchInput" placeholder="アドレスを検索 (0x...) またはブロック高さを入力..." />
  </div>

  <!-- Balance result -->
  <div class="balance-result" id="balanceResult">
    <div class="balance-addr" id="balanceAddr"></div>
    <div class="balance-amount"><span id="balanceValue">0</span> <span class="btr">BTR</span></div>
    <div style="margin-top:0.5rem;font-size:0.75rem;color:var(--text-dim);font-family:var(--font-mono)">nonce: <span id="balanceNonce">0</span></div>
  </div>

  <!-- Stats -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-label">チェーン高さ</div>
      <div class="stat-value" id="statHeight">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">難易度</div>
      <div class="stat-value" id="statDifficulty">-<span class="unit">bits</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ノード数</div>
      <div class="stat-value" id="statNodes">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">クライアント</div>
      <div class="stat-value" id="statClients">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">稼働時間</div>
      <div class="stat-value" id="statUptime">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">バージョン</div>
      <div class="stat-value" id="statVersion" style="font-size:1rem">-</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-section">
    <div class="chart-card">
      <div class="chart-title">難易度推移</div>
      <div class="chart-wrap"><canvas id="diffChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ブロック時間 (秒)</div>
      <div class="chart-wrap"><canvas id="timeChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">報酬 (BTR/block)</div>
      <div class="chart-wrap"><canvas id="rewardChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">トランザクション数/ブロック</div>
      <div class="chart-wrap"><canvas id="txChart"></canvas></div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="blocks">ブロック</button>
    <button class="tab" data-tab="txs">トランザクション</button>
  </div>

  <!-- Blocks table -->
  <div class="table-wrap" id="blocksTab">
    <table>
      <thead>
        <tr>
          <th>高さ</th>
          <th>ハッシュ</th>
          <th>マイナー</th>
          <th>報酬</th>
          <th>TX</th>
          <th>難易度</th>
          <th>時刻</th>
        </tr>
      </thead>
      <tbody id="blocksBody">
        <tr><td colspan="7" class="loading">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- TX table -->
  <div class="table-wrap" id="txsTab" style="display:none">
    <table>
      <thead>
        <tr>
          <th>署名</th>
          <th>From</th>
          <th>To</th>
          <th>金額</th>
          <th>種別</th>
        </tr>
      </thead>
      <tbody id="txsBody">
        <tr><td colspan="5" class="loading">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
const API = location.origin;
const WEI = 1000000000000000000n;

function weiToBtr(wei) {
  if (!wei || wei === '0') return '0';
  try {
    const b = BigInt(wei);
    const whole = b / WEI;
    const frac = b % WEI;
    if (frac === 0n) return whole.toString();
    const fracStr = frac.toString().padStart(18, '0').replace(/0+$/, '');
    return `${whole}.${fracStr.slice(0, 4)}`;
  } catch { return '0'; }
}

function shortHash(h) { return h ? h.slice(0, 10) + '...' + h.slice(-6) : '-'; }
function shortAddr(a) { return a ? a.slice(0, 8) + '...' + a.slice(-4) : '-'; }
function fmtTime(ts) {
  if (!ts) return '-';
  const d = new Date(ts);
  return d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
function fmtUptime(s) {
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

// ============= Charts =============
const chartOpts = {
  responsive: true,
  maintainAspectRatio: false,
  animation: { duration: 300 },
  plugins: { legend: { display: false } },
  scales: {
    x: {
      display: true,
      grid: { color: '#1e293b' },
      ticks: { color: '#475569', font: { family: 'JetBrains Mono', size: 9 }, maxTicksLimit: 8 }
    },
    y: {
      display: true,
      grid: { color: '#1e293b' },
      ticks: { color: '#475569', font: { family: 'JetBrains Mono', size: 9 } }
    }
  }
};

function mkChart(id, color, label) {
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: color + '18', borderWidth: 1.5, pointRadius: 1.5, pointBackgroundColor: color, fill: true, tension: 0.3 }] },
    options: { ...chartOpts }
  });
}

const diffChart = mkChart('diffChart', '#10b981', '難易度');
const timeChart = mkChart('timeChart', '#3b82f6', 'ブロック時間');
const rewardChart = mkChart('rewardChart', '#f59e0b', '報酬');
const txChart = mkChart('txChart', '#8b5cf6', 'TX数');

function updateCharts(blocks) {
  if (!blocks || blocks.length < 2) return;
  const sorted = [...blocks].sort((a, b) => a.height - b.height);
  const labels = sorted.map(b => `#${b.height}`);
  const diffs = sorted.map(b => b.difficulty || 0);
  const rewards = sorted.map(b => parseFloat(weiToBtr(b.reward)));
  const txCounts = sorted.map(b => (b.transactions || []).length);

  // ブロック間時間
  const times = [];
  for (let i = 1; i < sorted.length; i++) {
    const dt = (sorted[i].timestamp - sorted[i-1].timestamp) / 1000;
    times.push(dt > 0 ? dt : 0);
  }

  diffChart.data.labels = labels;
  diffChart.data.datasets[0].data = diffs;
  diffChart.update();

  timeChart.data.labels = labels.slice(1);
  timeChart.data.datasets[0].data = times;
  timeChart.update();

  rewardChart.data.labels = labels;
  rewardChart.data.datasets[0].data = rewards;
  rewardChart.update();

  txChart.data.labels = labels;
  txChart.data.datasets[0].data = txCounts;
  txChart.update();
}

// ============= Data fetching =============
let allBlocks = [];

async function fetchStatus() {
  try {
    const res = await fetch(`${API}/api/status`);
    const d = await res.json();
    document.getElementById('statHeight').textContent = d.chainHeight;
    document.getElementById('statDifficulty').innerHTML = d.difficulty + '<span class="unit">bits</span>';
    document.getElementById('statNodes').textContent = d.nodes;
    document.getElementById('statClients').textContent = d.clients;
    document.getElementById('statUptime').textContent = fmtUptime(d.uptime);
    document.getElementById('statVersion').textContent = 'v' + d.version;
    document.getElementById('statusText').textContent = `v${d.version} · シード#${d.mySeedId}`;
  } catch (e) {
    document.getElementById('statusText').textContent = 'オフライン';
  }
}

async function fetchBlocks() {
  try {
    const res = await fetch(`${API}/api/blocks?from=-50&to=0`);
    const d = await res.json();
    const blocks = d.blocks || [];
    allBlocks = blocks;
    renderBlocks(blocks);
    updateCharts(blocks);
  } catch (e) {
    console.error('fetchBlocks error:', e);
  }
}

async function fetchTransactions() {
  try {
    const res = await fetch(`${API}/api/transactions?limit=30`);
    const d = await res.json();
    renderTransactions(d.transactions || []);
  } catch {}
}

async function searchAddress(addr) {
  try {
    const res = await fetch(`${API}/api/balance/${addr}`);
    const d = await res.json();
    document.getElementById('balanceAddr').textContent = d.address || addr;
    document.getElementById('balanceValue').textContent = weiToBtr(d.balance);
    document.getElementById('balanceNonce').textContent = d.nonce || 0;
    document.getElementById('balanceResult').classList.add('show');
  } catch {
    document.getElementById('balanceResult').classList.remove('show');
  }
}

// ============= Rendering =============
function renderBlocks(blocks) {
  const tbody = document.getElementById('blocksBody');
  if (!blocks || blocks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="loading">ブロックなし</td></tr>';
    return;
  }
  const sorted = [...blocks].sort((a, b) => b.height - a.height);
  tbody.innerHTML = sorted.map(b => `
    <tr>
      <td class="height-cell">#${b.height}</td>
      <td class="hash-cell" title="${b.hash}">${shortHash(b.hash)}</td>
      <td class="miner-cell" title="${b.miner}">${shortAddr(b.miner)}</td>
      <td class="reward-cell">${weiToBtr(b.reward)} BTR</td>
      <td class="tx-cell">${(b.transactions || []).length}</td>
      <td class="diff-cell">${b.difficulty || '-'}</td>
      <td class="time-cell">${fmtTime(b.timestamp)}</td>
    </tr>
  `).join('');
}

function renderTransactions(txs) {
  const tbody = document.getElementById('txsBody');
  if (!txs || txs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="loading">トランザクションなし</td></tr>';
    return;
  }
  tbody.innerHTML = txs.map(tx => `
    <tr>
      <td class="hash-cell" title="${tx.signature || ''}">${shortHash(tx.signature || '')}</td>
      <td class="miner-cell" title="${tx.from || ''}">${shortAddr(tx.from)}</td>
      <td class="miner-cell" title="${tx.to || ''}">${shortAddr(tx.to)}</td>
      <td class="reward-cell">${weiToBtr(tx.amount)} BTR</td>
      <td>${tx.type || 'transfer'}</td>
    </tr>
  `).join('');
}

// ============= Tabs =============
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const name = tab.dataset.tab;
    document.getElementById('blocksTab').style.display = name === 'blocks' ? '' : 'none';
    document.getElementById('txsTab').style.display = name === 'txs' ? '' : 'none';
    if (name === 'txs') fetchTransactions();
  });
});

// ============= Search =============
document.getElementById('searchInput').addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;
  const q = e.target.value.trim();
  if (!q) { document.getElementById('balanceResult').classList.remove('show'); return; }
  if (q.startsWith('0x')) {
    searchAddress(q);
  } else {
    const h = parseInt(q);
    if (!isNaN(h)) {
      // ブロック高さ検索: ブロック詳細表示
      searchAddress(''); // hide
      window.open(`${API}/api/block/${h}`, '_blank');
    }
  }
});

// ============= Init & Auto-refresh =============
fetchStatus();
fetchBlocks();

setInterval(fetchStatus, 10000);
setInterval(fetchBlocks, 15000);
</script>
</body>
</html>